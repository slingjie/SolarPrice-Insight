# 发电量计算与辐照数据结合流程需求文档

**版本**: v1.1
**更新时间**: 2025-12-30

本文档详细描述了从“辐照度查询”到“发电量计算”的交互流程、数据流转及界面状态变化，旨在消除独立组件之间的割裂感，提供流畅的用户体验。

## 1. 核心流程概述

用户路径设计为线性引导流程：
`[地点选择与辐照查询]` -> `[确认辐照数据]` -> `[一键跳转发电量计算]` -> `[查看发电收益]`

---

## 2. 详细交互流程

### 第一阶段：辐照度查询 (Irradiance Query)

**界面状态：**
- **初始状态**：用户通过“经纬度”或“地址/公司名称”输入位置。
- **查询动作**：点击“查询辐照数据”按钮，系统调用 PVGIS TMY 接口。
- **结果展示**：
    - 展示“站点信息 (Site Info)”面板（含 GHI, DNI, 最佳倾角等）。
    - 展示月度辐照图表和日内曲线。

**关键变更点的交互逻辑：**
1.  **按钮状态流转**：
    -   **未查询/查询中**：按钮显示“查询辐照数据”（保持现状）。
    -   **查询成功后**：按钮**自动变更**为“下一步：计算发电量” (或在“查询”按钮旁高亮显示独立的“下一步”按钮，推荐采用**双按钮并存**或**状态切换**模式，见下文建议)。
    -   *建议方案*：查询成功后，原“查询”按钮保持，但在其右侧或下方弹出一个主色调（Orange-500）的**“前往计算发电量 (Go to Power Calc)”** 引导按钮/Banner，避免用户想重新查询时找不到入口。

2.  **数据缓存**：
    -   查询成功的数据（TMY Result）已通过 `pvgisService` 写入 RxDB 缓存。
    -   缓存 Key 为 `hash({lat, lon, ...})`。

### 第二阶段：跳转与参数传递 (Transition)

**触发动作**：用户点击“下一步：计算发电量”按钮。

**系统行为**：
1.  **路由跳转**：导航至 `/pvgis/power-calculation`（或对应路由）。
2.  **参数携带**：通过 URL Query Params 或 React Router State 传递以下核心参数：
    -   `lat`: 纬度 (e.g., 30.27)
    -   `lon`: 经度 (e.g., 120.15)
    -   `address`: 解析后的地址名称 (用于显示，如“杭州市余杭区...”)
    -   `source`: `irradiance_query` (标记来源，用于触发 UI 锁定逻辑)

### 第三阶段：发电量计算 (Power Calculation)

**界面初始化逻辑**：
1.  **自动填充 (Auto-fill)**：
    -   组件挂载时，读取传入的 `lat`, `lon`。
    -   自动填入“系统参数”中的地理位置信息。
2.  **UI 锁定 (Locking)**：
    -   **地理位置输入框**：进入**只读 (Read-only)** 模式或**锁定**状态。
    -   *设计意图*：因为发电量计算依赖于上一步确认的辐照数据位置，防止用户在计算页随意修改导致数据不一致。
    -   **解锁/重置入口**：提供一个“重选位置”的小链接，点击后跳回“辐照度查询”页或允许解锁编辑（但在当前页编辑意味着只有经纬度，没有详细辐照图表预览，建议跳回）。

3.  **计算参数配置**：
    -   **系统参数**：装机容量、系统损耗、方位角、倾角。
    -   **默认值智能填充**：
        -   **方位角 (Azimuth)**：默认为 0 (正南) 或 180 (视北半球逻辑而定)。
        -   **倾角 (Tilt/Slope)**：
            -   **方案 A (推荐)**：自动填入上一步“站点信息”中获取的**PVGIS 最佳倾角 (Optimal Slope)**（如果上一步已获取）。
            -   方案 B：勾选“自动优化倾角”选项（默认勾选）。

4.  **计算执行 (Execution)**：
    -   用户点击“开始测算”。
    -   **数据源复用**：`pvgisService.getPVData` 被调用。由于 `lat/lon` 与上一步一致，且 Service 层已通过 RxDB 实现了 Request Deduping / Cache，本次 API 请求应**瞬间完成**（命中缓存），直接返回包含发电量的完整结果。

5.  **结果展示**：
    -   展示年度/月度发电量、满发小时数、PR 值等。
    -   显示“数据来源：基于已确认的辐照数据”。

---

## 3. 异常处理与边界情况

1.  **直接访问发电量计算页**：
    -   若用户未经过“辐照查询”直接访问该页面。
    -   **行为**：地理位置输入框**不锁定**，允许用户手动输入经纬度或搜索。
    -   **区别**：此时没有上一步的详细辐照预览，属于“快速测算”模式。

2.  **页面刷新**：
    -   若在“发电量计算”页刷新。
    -   URL 参数应保持，确保位置信息不丢失，UI 仍保持锁定状态。

3.  **缓存失效**：
    -   若极少数情况下缓存被清除。
    -   Service 层会自动重新发起请求，用户感知仅为轻微的 Loading 延迟，流程不受阻。

---

## 4. 开发任务分解 (To-Do)

- [ ] **IrradianceQuery.tsx 修改**
    - [ ] 增加“计算发电量”跳转按钮状态逻辑。
    - [ ] 实现 `useNavigate` 跳转并携带 state/query 参数。

- [ ] **PowerCalculation.tsx 修改**
    - [ ] 增加 `useEffect` 处理入参 (`useLocation` / `useSearchParams`)。
    - [ ] 修改 `LocationInput` 组件，支持 `readOnly` 属性。
    - [ ] 实现初始化时自动填充 Lat/Lon。
    - [ ] 优化参数默认值逻辑（尝试读取最佳倾角）。

- [ ] **Service 层确认**
    - [ ] 确保 `getPVData` 能正确利用之前 `getTMYData` 或 `getIrradianceSeries` 产生的缓存（注意：PVGIS API 中 TMY 和 PVCalc 是不同接口，可能无法直接复用 HTTP 响应缓存，但 Parameter Hash 机制应确保参数一致性）。
    - *技术注记*：`getTMYData` (tmy endpoint) 和 `getPVData` (PVcalc endpoint) 是两个不同 API。虽然地点一样，但 PVCalc 需要重新请求 API (除非我们只用 TMY 数据自己算发电量，但这太复杂)。
    - **修正策略**：接受再次请求 API。因为 PVCalc 接口极快且 Service 层会对 `PVCalc` 结果本身做缓存。所以流程重点是**参数一致性**，而非强行复用 TMY 的 Response 體。

---

## 5. UI 文案规范

- **按钮**：`下一步：配置系统并测算`
- **位置锁定提示**：`位置已锁定 (来自辐照查询)，如需修改请返回上一步`