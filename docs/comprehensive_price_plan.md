# 月度综合电价计算器 - 实施方案

## 目标描述
开发一个新的功能页面“月度综合电价计算器”，用于计算指定省份、指定月份在特定时间段内的综合平均电价。用户可以输入自定义的时间范围（例如 8:00-16:00），程序将基于现有的分时电价（TOU）数据，计算该时间段内的加权平均电价。

## 需用户确认 (User Review Required)
> [!IMPORTANT]
> **关于计算逻辑的确认**：
> 默认将采用 **“时间加权平均法”** 进行计算。
> **公式**：`SUM(某时段电价 × 该时段时长) / 总时长`
>
> **示例**：
> 如果您选择的时间段是 10:00 - 12:00（共2小时）：
> - 10:00-11:00 是高峰（电价 1.0元），时长1小时
> - 11:00-12:00 是平时（电价 0.5元），时长1小时
> - **综合电价** = (1.0×1 + 0.5×1) / 2 = 0.75 元
>
> 请确认此逻辑是否符合您对“综合电价”的定义。

## 建议变更 (Proposed Changes)

### 1. 数据类型与路由 (Data Types & Routing)
#### [MODIFY] [types.ts](file:///Users/shilingjie/Desktop/ai/1221%2095598/types.ts)
- 更新 `AppView` 类型定义，增加 `'calculator'` 视图状态。

#### [MODIFY] [Sidebar.tsx](file:///Users/shilingjie/Desktop/ai/1221%2095598/components/Sidebar.tsx)
- 在侧边栏导航菜单中新增 “综合电价计算” (Comprehensive Price) 入口。

#### [MODIFY] [App.tsx](file:///Users/shilingjie/Desktop/ai/1221%2095598/App.tsx)
- 在主渲染逻辑中添加 `ComprehensivePriceCalculator` 组件的路由判断。

### 2. 新增组件 (New Component)
#### [NEW] [ComprehensivePriceCalculator.tsx](file:///Users/shilingjie/Desktop/ai/1221%2095598/components/ComprehensivePriceCalculator.tsx)
- **输入项**：
    - **省份 (Province)**：下拉选择（数据来源 `PROVINCES` 常量）。
    - **用电分类 & 电压等级**：下拉选择（根据所选省份的现有数据动态加载）。
    - **月份 (Months)**：多选框（支持勾选多个月份）。
    - **时间段 (Time Range)**：起始时间 (Start Time) 和 结束时间 (End Time) 输入框。
- **业务逻辑**：
    - 从 RxDB 数据库获取对应的电价数据 (`tariffs`)。
    - 遍历每一个被选中的月份，获取其对应的时段规则 (`time_rules`) 和价格表 (`prices`)。
    - 计算用户输入的时间段与各电价时段的重叠时长。
    - 根据加权公式计算该月的综合电价。
    - 如果选择了多个月份，额外计算所有选中月份综合电价的算术平均值。
- **输出展示**：
    - **明细表格**：显示 月份 | 起始时间 | 结束时间 | 计算结果(综合电价)。
    - **汇总信息**：显示所选月份的 **平均月综合电价**。

## 验证计划 (Verification Plan)

### 手动验证 (Manual Verification)
1.  **准备数据**：确保数据库中存在“浙江省-1月”的电价数据，并已知其峰谷电价（例如：高峰 1.0元，低谷 0.5元）。
    *   假设时段规则：08:00-11:00 为高峰，11:00-13:00 为低谷。
2.  **测试用例 1 (单一时段)**：
    *   选择“浙江省”、“1月”。
    *   设置时间段：09:00 - 10:00 (1小时，完全在高峰期内)。
    *   **预期结果**：结果应等于高峰电价 (1.0元)。
3.  **测试用例 2 (跨时段)**：
    *   设置时间段：10:00 - 12:00 (2小时)。
    *   重叠情况：10:00-11:00 (1小时高峰), 11:00-12:00 (1小时低谷)。
    *   **预期结果**：(1.0×1 + 0.5×1) / 2 = 0.75元。
4.  **测试用例 3 (多月平均)**：
    *   勾选“1月”和“2月”。
    *   **预期结果**：列表显示1月和2月各自的综合电价，下方显示两者的平均值。
